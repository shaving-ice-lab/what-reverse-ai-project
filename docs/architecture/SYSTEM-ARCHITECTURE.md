# 系统架构与模块边界

版本：v1.0
日期：2026-02-03
状态：Active

---

## 1. 目标架构图

### 逻辑架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   客户端层                                       │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐      │
│  │   Web App   │    │  Mobile App │    │  SDK Client │    │  API Client │      │
│  └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘      │
└─────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   接入层                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────────────────────┐   │
│  │                        API Gateway / Load Balancer                       │   │
│  │  • 请求路由  • 限流  • 认证  • TLS 终止  • 域名映射                       │   │
│  └─────────────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                          │
          ┌───────────────────────────────┼───────────────────────────────┐
          ▼                               ▼                               ▼
┌─────────────────┐           ┌─────────────────┐           ┌─────────────────┐
│    Web Server   │           │   API Server    │           │  Runtime Server │
│  (Next.js SSR)  │           │   (Go HTTP)     │           │   (Go HTTP)     │
│                 │           │                 │           │                 │
│ • 页面渲染      │           │ • REST API      │           │ • 公开访问入口   │
│ • 静态资源      │           │ • WebSocket     │           │ • 匿名会话      │
│ • Auth 回调     │           │ • 业务逻辑      │           │ • 执行触发      │
└─────────────────┘           └─────────────────┘           └─────────────────┘
                                          │                               │
                                          ▼                               ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   服务层                                         │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │   Workspace   │  │     App       │  │    Runtime    │  │   Billing     │   │
│  │    Service    │  │   Service     │  │    Service    │  │   Service     │   │
│  │               │  │               │  │               │  │               │   │
│  │ • 空间管理    │  │ • 应用管理    │  │ • 访问解析    │  │ • 用量计量    │   │
│  │ • 成员管理    │  │ • 版本管理    │  │ • 会话管理    │  │ • 配额控制    │   │
│  │ • 权限管理    │  │ • 发布管理    │  │ • 执行触发    │  │ • 账单结算    │   │
│  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘   │
│                                                                                 │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐   │
│  │  DB Provider  │  │    Domain     │  │   Execution   │  │      AI       │   │
│  │    Service    │  │   Service     │  │    Service    │  │   Service     │   │
│  │               │  │               │  │               │  │               │   │
│  │ • DB 创建     │  │ • 域名绑定    │  │ • 工作流执行  │  │ • LLM 调用    │   │
│  │ • 迁移管理    │  │ • DNS 验证    │  │ • 节点调度    │  │ • 意图识别    │   │
│  │ • 密钥轮换    │  │ • 证书管理    │  │ • 日志记录    │  │ • 内容生成    │   │
│  └───────────────┘  └───────────────┘  └───────────────┘  └───────────────┘   │
└─────────────────────────────────────────────────────────────────────────────────┘
                                          │
                                          ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                                   基础设施层                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐    │
│  │   MySQL   │  │   Redis   │  │   Queue   │  │  Storage  │  │    LLM    │    │
│  │  (主库)   │  │  (缓存)   │  │  (任务)   │  │  (文件)   │  │  (模型)   │    │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘  └───────────┘    │
│                                                                                 │
│  ┌───────────────────────────────────────────────────────────────────────┐     │
│  │                    Workspace 独立数据库 (MySQL/PostgreSQL)             │     │
│  │      ws_xxx_1        ws_xxx_2        ws_xxx_3        ...               │     │
│  └───────────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 服务边界定义

### 2.1 Workspace Service

**职责**：租户管理与权限控制

| 能力 | 说明 |
|-----|------|
| 空间管理 | 创建、更新、删除 Workspace |
| 成员管理 | 邀请、移除、角色变更 |
| 权限管理 | 角色定义、权限校验 |
| 默认空间 | 用户注册时自动创建 |

**边界**：
- 不直接操作 App、Workflow 资源
- 不处理 Runtime 请求
- 不管理计费逻辑

---

### 2.2 App Service

**职责**：应用生命周期管理

| 能力 | 说明 |
|-----|------|
| 应用管理 | CRUD + 状态变更 |
| 版本管理 | 版本创建、回滚 |
| 发布管理 | 发布、下线、归档 |
| 访问策略 | 配置访问模式和限流 |

**边界**：
- 不处理 Runtime 执行
- 不管理域名证书
- 依赖 Workspace 权限校验

---

### 2.3 Runtime Service

**职责**：公开访问入口与执行触发

| 能力 | 说明 |
|-----|------|
| 访问解析 | 解析 slug 或域名到 App |
| 会话管理 | 创建和管理匿名会话 |
| 执行触发 | 调用 Execution Service |
| 限流控制 | 按策略限制访问 |

**边界**：
- 不修改 App 配置
- 不直接操作数据库
- 依赖 App Service 获取配置

---

### 2.4 DB Provisioner Service

**职责**：Workspace 独立数据库管理

| 能力 | 说明 |
|-----|------|
| 数据库创建 | 创建独立库和用户 |
| 迁移管理 | 执行 Schema 迁移 |
| 密钥管理 | 加密存储和轮换 |
| 连接池 | 管理运行时连接 |

**边界**：
- 不处理业务数据
- 仅管理数据库基础设施
- 依赖 Workspace 权限

---

### 2.5 Domain Service

**职责**：域名绑定与证书管理

| 能力 | 说明 |
|-----|------|
| 域名绑定 | 接收并记录域名 |
| DNS 验证 | TXT/CNAME 校验 |
| 证书管理 | 签发和续期 TLS |
| 路由映射 | 域名到 App 的映射 |

**边界**：
- 不处理 Runtime 请求
- 不修改 App 配置
- 依赖外部 DNS/CA 服务

---

### 2.6 Billing Service

**职责**：计费与配额管理

| 能力 | 说明 |
|-----|------|
| 用量计量 | 统计 requests/tokens/storage |
| 配额控制 | 检查和扣减配额 |
| 套餐管理 | 管理 plan 和限额 |
| 账单结算 | 生成账单和发票 |

**边界**：
- 不执行工作流
- 不管理用户数据
- 提供配额查询接口

---

## 3. 存储边界

### 3.1 平台主库

**用途**：存储平台核心数据

| 数据类型 | 表 |
|---------|---|
| 用户数据 | users, user_settings |
| 空间数据 | workspaces, workspace_members, workspace_roles |
| 应用数据 | apps, app_versions, app_access_policies, app_domains |
| 工作流数据 | workflows, executions, node_logs |
| 计费数据 | billing_plans, workspace_quotas, billing_usage_events |
| 审计数据 | audit_logs, runtime_events |

### 3.2 Workspace 独立库

**用途**：存储 App 业务数据

| 特点 | 说明 |
|-----|------|
| 隔离性 | 每个 Workspace 一个库 |
| 命名 | `ws_<workspace_id>` |
| 访问 | 仅通过 DB 节点访问 |
| 迁移 | App 定义的 db_schema |

### 3.3 数据流说明

```
┌─────────────────────────────────────────────────────────────────┐
│                         数据流向                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  用户请求 ──▶ API Server ──▶ 平台主库                           │
│                    │                                            │
│                    ▼                                            │
│  公开访问 ──▶ Runtime ──▶ Execution ──▶ DB 节点                 │
│                                            │                    │
│                                            ▼                    │
│                                    Workspace 独立库             │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

数据库责任划分：
┌──────────────────┬────────────────────────────────────────────┐
│     平台主库      │           Workspace 独立库                  │
├──────────────────┼────────────────────────────────────────────┤
│ • 用户认证        │ • App 业务数据                              │
│ • 空间/应用元数据  │ • 用户生成内容                              │
│ • 工作流定义      │ • 执行结果存储                              │
│ • 执行日志        │ • 自定义表结构                              │
│ • 计费/配额       │                                            │
│ • 审计日志        │                                            │
└──────────────────┴────────────────────────────────────────────┘
```

---

## 4. 部署架构

### 4.1 单区域部署

```
Region: ap-east-1
├── Load Balancer (ALB)
│   ├── *.agentflow.ai → Web/API
│   └── Custom domains → Runtime
├── Web Server (ECS/K8s)
│   └── 2+ replicas
├── API Server (ECS/K8s)
│   └── 3+ replicas
├── Runtime Server (ECS/K8s)
│   └── 3+ replicas
├── Worker (ECS/K8s)
│   └── 2+ replicas
├── MySQL (RDS)
│   ├── Primary
│   └── Read Replica
├── Redis (ElastiCache)
│   └── Cluster mode
└── Workspace DBs (RDS)
    └── Dynamic provisioning
```

### 4.2 多区域扩展

```
Global
├── Region: ap-east-1 (Primary)
│   └── Full stack
├── Region: us-west-2
│   └── Full stack (replica)
└── Region: eu-west-1
    └── Full stack (replica)

跨区域数据同步：
• 用户/空间数据：主库同步
• Workspace DB：不跨区（region 绑定）
• 配置/Feature：全局配置服务
```

---

## 5. 技术选型

| 组件 | 技术选择 | 理由 |
|-----|---------|------|
| Web 前端 | Next.js 14 | SSR + RSC + App Router |
| API 服务 | Go + Gin | 高性能 + 类型安全 |
| 数据库 | MySQL 8.0 | 成熟稳定 + JSON 支持 |
| 缓存 | Redis 7.0 | 高性能 + 丰富数据结构 |
| 队列 | Asynq (Redis) | Go 原生 + 简单可靠 |
| 对象存储 | S3/OSS | 可扩展 + 成本低 |
| 监控 | Prometheus + Grafana | 标准方案 |
| 日志 | ELK / Loki | 可搜索 + 聚合 |
| 追踪 | OpenTelemetry | 标准协议 |

---

## 变更记录

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-03 | v1.0 | 初始版本 | AgentFlow Team |
