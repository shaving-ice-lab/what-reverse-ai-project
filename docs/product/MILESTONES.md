# 里程碑与阶段划分

版本：v1.0
日期：2026-02-03
状态：Active

---

## 1. 阶段概览

```
Phase 0          Phase 1          Phase 2          Phase 3          Phase 4
数据模型基础      App 运行时        独立数据库        域名绑定          计费增长
    │               │               │               │               │
    ▼               ▼               ▼               ▼               ▼
┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
│Workspace│    │ Runtime │    │   DB    │    │ Domain  │    │Billing │
│基础模型  │ → │公开访问  │ → │独立数据库│ → │TLS证书  │ → │监控增长 │
└─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
```

---

## 2. Phase 0：数据模型与 Workspace 基础

### 目标

建立 Workspace 和 App 的基础数据模型，支持默认空间创建和绑定。

### 交付物

| 交付物 | 说明 | 验收标准 |
|-------|------|---------|
| Schema 迁移 | workspace/app 相关表 | 迁移脚本可执行 |
| 默认 Workspace | 用户注册自动创建 | 所有用户有空间 |
| 数据回填 | 现有数据绑定 workspace | 无数据丢失 |

### 关键任务

- [x] 设计 workspaces 表结构
- [x] 设计 apps/app_versions 表结构
- [x] 实现默认 Workspace 创建逻辑
- [x] 实现数据回填迁移脚本
- [x] Workspace 基础 CRUD API

---

## 3. Phase 1：App 运行时与公开访问

### 目标

实现 App 的公开访问入口，支持匿名访问和会话管理。

### 交付物

| 交付物 | 说明 | 验收标准 |
|-------|------|---------|
| Runtime 路由 | `/{workspaceSlug}/{appSlug}` | URL 可解析 |
| 访问策略 | private/public_auth/public_anonymous | 策略生效 |
| 匿名会话 | session_id 生成和管理 | 会话可追踪 |
| 执行触发 | 通过 Runtime 执行工作流 | 返回结果 |

### 关键任务

- [x] 实现 Runtime 入口解析
- [x] 实现访问策略校验
- [x] 实现匿名会话创建
- [x] 实现限流控制
- [x] 前端公开访问页

---

## 4. Phase 2：独立数据库与 DB 节点

### 目标

每个 Workspace 可拥有独立数据库，支持 DB 节点真实执行。

### 交付物

| 交付物 | 说明 | 验收标准 |
|-------|------|---------|
| DB Provision | 自动创建独立库 | 数据库可连接 |
| DB 节点 | select/insert/update/delete | 真实执行 |
| 迁移机制 | Schema 版本管理 | 可迁移升级 |
| 密钥管理 | 加密存储和轮换 | 不明文存储 |

### 关键任务

- [x] 实现 DB Provisioner Service
- [x] 实现 Workspace DB 连接池
- [x] 实现 DB 节点执行器
- [x] 实现迁移脚本管理
- [x] 实现密钥加密存储

---

## 5. Phase 3：域名绑定与 TLS

### 目标

支持 App 绑定自定义域名，自动签发和续期 TLS 证书。

### 交付物

| 交付物 | 说明 | 验收标准 |
|-------|------|---------|
| 域名绑定 | 添加和验证域名 | 域名可绑定 |
| DNS 验证 | TXT/CNAME 校验 | 验证通过 |
| TLS 证书 | 自动签发和续期 | HTTPS 可用 |
| 域名路由 | 域名到 App 映射 | 域名可访问 |

### 关键任务

- [x] 实现域名绑定 API
- [x] 实现 DNS 验证逻辑
- [x] 集成证书签发服务
- [x] 实现域名路由解析
- [x] 实现证书续期任务

---

## 6. Phase 4：计费、监控、增长

### 目标

实现完整的计费体系、监控告警和用户增长功能。

### 交付物

| 交付物 | 说明 | 验收标准 |
|-------|------|---------|
| 计费模型 | requests/tokens/storage | 可计量 |
| 配额控制 | 用量限制和超额处理 | 可限制 |
| 监控指标 | Prometheus 指标暴露 | 可监控 |
| 增长漏斗 | 核心转化追踪 | 可分析 |

### 关键任务

- [x] 设计计费维度和套餐
- [x] 实现配额扣减和检查
- [x] 实现 App 用量统计
- [ ] 增长指标埋点
- [ ] A/B 测试框架

---

## 7. 依赖关系

```
Phase 0 ──────┬──────► Phase 1
              │
              │        Phase 2 ──────► Phase 3
              │           │
              └───────────┘
                          │
                          └──────────► Phase 4
```

| 阶段 | 前置依赖 |
|-----|---------|
| Phase 0 | 无 |
| Phase 1 | Phase 0 |
| Phase 2 | Phase 0 |
| Phase 3 | Phase 1, Phase 2 |
| Phase 4 | Phase 1, Phase 2, Phase 3 |

---

## 8. 风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 数据迁移失败 | 服务不可用 | 全量备份 + 灰度 |
| 性能下降 | 用户体验差 | 压测 + 监控 |
| 安全漏洞 | 数据泄露 | 安全审计 + 扫描 |
| 依赖故障 | 功能不可用 | 降级 + 回退 |

---

## 变更记录

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-03 | v1.0 | 初始版本 | AgentFlow Team |
