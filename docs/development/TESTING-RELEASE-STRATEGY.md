# 测试与发布策略

版本：v1.0
日期：2026-02-03
状态：Active

---

## 1. 测试策略

### 测试金字塔

```
                    ┌─────────┐
                    │  E2E    │ 10%
                   ┌┴─────────┴┐
                   │ 集成测试  │ 20%
                  ┌┴───────────┴┐
                  │   单元测试   │ 70%
                  └─────────────┘
```

### 1.1 单元测试

**覆盖范围**：
- 工作流执行：节点执行器、变量解析
- AI 生成：输出解析、校验逻辑
- 权限检查：角色权限、访问控制

**测试清单**：

```markdown
## 工作流执行
- [ ] start 节点输入解析
- [ ] llm 节点调用和响应处理
- [ ] http 节点请求和重试
- [ ] db 节点 CRUD 操作
- [ ] condition 节点分支逻辑
- [ ] loop 节点迭代执行
- [ ] 变量引用和模板渲染
- [ ] 错误处理和回滚

## AI 生成
- [ ] 意图识别准确性
- [ ] 工作流 JSON 生成
- [ ] UI Schema 生成
- [ ] DB Schema 生成
- [ ] 输出校验和自动修复
- [ ] 增量更新和 diff 生成

## 权限
- [ ] 角色权限映射
- [ ] Workspace 成员校验
- [ ] App 访问策略校验
- [ ] API 端点权限检查
```

### 1.2 集成测试

**测试用例**：

| 场景 | 测试内容 | 验收标准 |
|-----|---------|---------|
| Workspace 创建 | 用户注册后创建默认空间 | 自动创建成功 |
| DB Provision | 创建独立数据库 | 数据库可连接 |
| App 访问 | 公开链接访问 App | 正确返回 UI |
| 执行触发 | 提交输入并执行 | 返回执行结果 |
| 域名绑定 | 绑定并验证域名 | DNS 验证通过 |

### 1.3 安全测试

**测试用例**：

| 测试项 | 测试内容 | 预期结果 |
|-------|---------|---------|
| 匿名滥用 | 高频请求 | 触发限流 |
| SQL 注入 | 恶意 SQL 输入 | 参数化防护 |
| 权限绕过 | 越权访问 | 403 拒绝 |
| XSS 攻击 | 脚本注入 | 转义过滤 |
| CSRF 攻击 | 伪造请求 | Token 校验 |

---

## 2. 发布策略

### 2.1 灰度发布

**灰度维度**：

| 维度 | 说明 |
|-----|------|
| Workspace 白名单 | 指定空间优先体验 |
| 用户白名单 | 指定用户优先体验 |
| 流量比例 | 按百分比分流 |
| 地域 | 按区域逐步放量 |

**灰度流程**：

```
1. 开发完成
    │
    ▼
2. 内部测试 (1%)
    │ → 验证基本功能
    ▼
3. 内测用户 (5%)
    │ → 收集反馈
    ▼
4. 小流量 (20%)
    │ → 监控指标
    ▼
5. 大流量 (50%)
    │ → 确认稳定
    ▼
6. 全量发布 (100%)
```

### 2.2 回滚机制

**App 版本回滚**：

```bash
# API 调用
POST /api/v1/apps/:id/rollback
{
  "target_version_id": "ver_xxx",
  "reason": "功能回退"
}

# 回滚流程
1. 检查目标版本存在
2. 更新 current_version_id
3. 通知 Runtime 刷新缓存
4. 记录回滚审计日志
```

**Schema 回滚**：

```bash
# 数据库 Schema 回滚
1. 执行 down migration
2. 验证数据完整性
3. 更新 migration 记录
```

### 2.3 迁移窗口与维护通知

**维护窗口**：

| 类型 | 时间窗口 | 提前通知 |
|-----|---------|---------|
| 计划维护 | 周二 02:00-04:00 | 7 天 |
| 紧急修复 | 任意时间 | 尽快通知 |
| 数据迁移 | 周末 00:00-06:00 | 14 天 |

**通知模板**：

```markdown
## 系统维护通知

**维护时间**：2026-02-10 02:00-04:00 (UTC+8)
**影响范围**：全部服务将短暂不可用
**维护内容**：数据库升级和性能优化

**注意事项**：
- 请提前保存工作进度
- 维护期间 API 调用将返回 503
- 预计恢复时间：04:00

如有疑问请联系支持团队。
```

---

## 3. 线上验收指标

### 质量指标

| 指标 | 目标值 | 告警阈值 |
|-----|--------|---------|
| API 成功率 | ≥99.9% | <99.5% |
| 执行成功率 | ≥99% | <98% |
| P95 延迟 | <2s | >3s |
| P99 延迟 | <5s | >8s |
| 错误率 | <0.1% | >0.5% |

### 业务指标

| 指标 | 目标值 | 说明 |
|-----|--------|------|
| 首屏时间 | <1.5s | 页面首次渲染 |
| 交互延迟 | <100ms | 用户操作响应 |
| 表单提交 | <3s | 表单处理完成 |
| 执行反馈 | <5s | 执行结果返回 |

### 验收检查清单

```markdown
## 发布前检查
- [ ] 所有测试通过
- [ ] 性能指标达标
- [ ] 安全扫描无高危
- [ ] 监控告警配置完成
- [ ] 回滚方案准备就绪
- [ ] 值班人员确认

## 发布后验证
- [ ] 核心功能可用
- [ ] 监控指标正常
- [ ] 无异常告警
- [ ] 用户反馈无阻塞问题
```

---

## 变更记录

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|---------|------|
| 2026-02-03 | v1.0 | 初始版本 | AgentFlow Team |
