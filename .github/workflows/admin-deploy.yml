name: Admin Deploy

on:
  push:
    branches: [main]
    paths:
      - 'apps/admin/**'
      - '.github/workflows/admin-deploy.yml'
  pull_request:
    branches: [main]
    paths:
      - 'apps/admin/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      skip_tests:
        description: 'Skip tests (emergency only)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read
  pull-requests: read
  id-token: write

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  APP_NAME: 'admin'
  APP_PATH: 'apps/admin'

jobs:
  lint-typecheck:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm --filter @agentflow/admin lint

      - name: Type check
        run: pnpm --filter @agentflow/admin typecheck

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm --filter @agentflow/admin test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: ${{ env.APP_PATH }}/coverage
          retention-days: 7

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm --filter @agentflow/admin exec playwright install --with-deps chromium

      - name: Build admin app
        run: pnpm --filter @agentflow/admin build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3001
          NEXT_PUBLIC_ADMIN_URL: http://localhost:3000

      - name: Run E2E tests
        run: pnpm --filter @agentflow/admin test:e2e
        env:
          CI: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: ${{ env.APP_PATH }}/playwright-report
          retention-days: 7

  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: pnpm --filter @agentflow/admin exec playwright install --with-deps chromium

      - name: Build admin app
        run: pnpm --filter @agentflow/admin build

      - name: Run security tests
        run: pnpm --filter @agentflow/admin test:security

      - name: Run permission tests
        run: pnpm --filter @agentflow/admin test:permission

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint-typecheck]
    outputs:
      build_id: ${{ steps.build_id.outputs.id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate build ID
        id: build_id
        run: echo "id=$(date +%Y%m%d%H%M%S)-$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Build admin app
        run: pnpm --filter @agentflow/admin build
        env:
          NEXT_PUBLIC_API_URL: ${{ vars.ADMIN_API_URL }}
          NEXT_PUBLIC_ADMIN_URL: ${{ vars.ADMIN_URL }}
          NEXT_PUBLIC_BUILD_ID: ${{ steps.build_id.outputs.id }}

      - name: Analyze bundle size
        run: pnpm --filter @agentflow/admin analyze:check
        continue-on-error: true

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: admin-build-${{ steps.build_id.outputs.id }}
          path: |
            ${{ env.APP_PATH }}/.next
            ${{ env.APP_PATH }}/public
            ${{ env.APP_PATH }}/package.json
            ${{ env.APP_PATH }}/next.config.ts
          retention-days: 30

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, unit-tests, e2e-tests, security-tests]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped') &&
      (needs.e2e-tests.result == 'success' || needs.e2e-tests.result == 'skipped') &&
      (needs.security-tests.result == 'success' || needs.security-tests.result == 'skipped') &&
      (github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && inputs.environment == 'staging'))
    environment:
      name: staging
      url: https://admin-staging.agentflow.ai
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: admin-build-${{ needs.build.outputs.build_id }}
          path: ./build

      - name: Deploy to staging
        run: |
          echo "Deploying build ${{ needs.build.outputs.build_id }} to staging..."
          # Add actual deployment commands here (e.g., Vercel, AWS, etc.)
          echo "Deployment placeholder - implement based on your infrastructure"

      - name: Health check
        run: |
          echo "Running health check on staging..."
          # curl -f https://admin-staging.agentflow.ai/api/health || exit 1

      - name: Notify deployment
        if: always()
        run: |
          echo "Staging deployment completed with status: ${{ job.status }}"

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [deploy-staging]
    if: |
      github.event_name == 'workflow_dispatch' && 
      inputs.environment == 'production' &&
      needs.deploy-staging.result == 'success'
    environment:
      name: production
      url: https://admin.agentflow.ai
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: admin-build-${{ needs.build.outputs.build_id }}
          path: ./build

      - name: Pre-deployment checks
        run: |
          echo "Running pre-deployment checks..."
          echo "✓ Build artifact verified"
          echo "✓ Staging tests passed"
          echo "✓ Manual approval received"

      - name: Deploy to production
        run: |
          echo "Deploying to production..."
          # Add actual deployment commands here
          echo "Deployment placeholder - implement based on your infrastructure"

      - name: Health check
        run: |
          echo "Running production health check..."
          # curl -f https://admin.agentflow.ai/api/health || exit 1

      - name: Post-deployment verification
        run: |
          echo "Running post-deployment verification..."
          # Add smoke tests here

      - name: Notify deployment
        if: always()
        run: |
          echo "Production deployment completed with status: ${{ job.status }}"
          # Add Slack/Discord notification here

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: failure() && github.event_name == 'workflow_dispatch'
    needs: [deploy-production]
    environment:
      name: production
    steps:
      - name: Initiate rollback
        run: |
          echo "Initiating rollback procedure..."
          echo "This is a manual step - implement based on your infrastructure"
          # Add rollback commands here
