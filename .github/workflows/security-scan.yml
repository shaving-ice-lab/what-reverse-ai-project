# 安全扫描工作流
# 用于定期扫描代码和依赖中的安全漏洞

name: Security Scan

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # 每周一早上8点运行
    - cron: '0 0 * * 1'
  workflow_dispatch:
  workflow_call:

permissions:
  contents: read
  security-events: write

jobs:
  # Go 代码安全扫描
  go-security:
    name: Go Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        run: govulncheck ./...

      - name: Install gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest

      - name: Run gosec
        run: gosec -fmt=sarif -out=gosec-results.sarif ./... || true

      - name: Upload gosec SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: apps/server/gosec-results.sarif
        if: always()

  # Node.js 依赖安全扫描
  npm-audit:
    name: NPM Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run npm audit (web)
        working-directory: apps/web
        run: pnpm audit --audit-level=high || true
        continue-on-error: true

      - name: Run npm audit (sdk)
        working-directory: packages/sdk
        run: pnpm audit --audit-level=high || true
        continue-on-error: true

  # 依赖更新检查
  dependency-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Check outdated packages (web)
        working-directory: apps/web
        run: pnpm outdated || true
        continue-on-error: true

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Check outdated Go modules
        working-directory: apps/server
        run: |
          go list -u -m all 2>/dev/null | grep '\[' || echo "All Go modules are up to date"
        continue-on-error: true

  # SBOM 生成与签名
  sbom-supply-chain:
    name: SBOM & Signing
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
      actions: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate SBOM (SPDX JSON)
        uses: anchore/sbom-action@v0
        with:
          path: .
          format: spdx-json
          output-file: sbom.spdx.json
          artifact-name: supply-chain-sbom.spdx.json
          upload-artifact: true

      - name: Install cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign SBOM
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign-blob --yes --output-certificate sbom.pem --output-signature sbom.sig sbom.spdx.json

      - name: Verify SBOM signature
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign verify-blob --certificate sbom.pem --signature sbom.sig sbom.spdx.json

      - name: Upload signature artifacts
        uses: actions/upload-artifact@v4
        with:
          name: supply-chain-signature
          path: |
            sbom.spdx.json
            sbom.sig
            sbom.pem

      - name: Upload SBOM & signature to API (optional)
        if: ${{ env.SUPPLY_CHAIN_API_BASE_URL != '' && env.SUPPLY_CHAIN_API_TOKEN != '' && env.SUPPLY_CHAIN_WORKSPACE_ID != '' }}
        env:
          SUPPLY_CHAIN_API_BASE_URL: ${{ secrets.SUPPLY_CHAIN_API_BASE_URL }}
          SUPPLY_CHAIN_API_TOKEN: ${{ secrets.SUPPLY_CHAIN_API_TOKEN }}
          SUPPLY_CHAIN_WORKSPACE_ID: ${{ secrets.SUPPLY_CHAIN_WORKSPACE_ID }}
          SUPPLY_CHAIN_ARTIFACT_TYPE: ${{ secrets.SUPPLY_CHAIN_ARTIFACT_TYPE }}
          SUPPLY_CHAIN_ARTIFACT_ID: ${{ secrets.SUPPLY_CHAIN_ARTIFACT_ID }}
        run: |
          sbom_payload=$(jq -n \
            --arg workspace_id "$SUPPLY_CHAIN_WORKSPACE_ID" \
            --arg artifact_type "${SUPPLY_CHAIN_ARTIFACT_TYPE:-repository}" \
            --arg artifact_id "${SUPPLY_CHAIN_ARTIFACT_ID:-${GITHUB_REPOSITORY}}" \
            --arg format "spdx-json" \
            --arg source "github-actions" \
            --arg generated_at "$(date -u +"%Y-%m-%dT%H:%M:%SZ")" \
            --argfile content sbom.spdx.json \
            '{workspace_id:$workspace_id,artifact_type:$artifact_type,artifact_id:$artifact_id,format:$format,source:$source,generated_at:$generated_at,content:$content}')

          curl -sS -X POST "${SUPPLY_CHAIN_API_BASE_URL}/api/v1/security/supply-chain/sboms" \
            -H "Authorization: Bearer ${SUPPLY_CHAIN_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$sbom_payload"

          signature_payload=$(jq -n \
            --arg workspace_id "$SUPPLY_CHAIN_WORKSPACE_ID" \
            --arg artifact_type "${SUPPLY_CHAIN_ARTIFACT_TYPE:-repository}" \
            --arg artifact_id "${SUPPLY_CHAIN_ARTIFACT_ID:-${GITHUB_REPOSITORY}}" \
            --arg digest "$(sha256sum sbom.spdx.json | cut -d' ' -f1)" \
            --arg algorithm "cosign" \
            --rawfile signature sbom.sig \
            --rawfile certificate sbom.pem \
            --arg source "github-actions" \
            '{workspace_id:$workspace_id,artifact_type:$artifact_type,artifact_id:$artifact_id,digest:$digest,algorithm:$algorithm,signature:$signature,certificate:$certificate,source:$source}')

          curl -sS -X POST "${SUPPLY_CHAIN_API_BASE_URL}/api/v1/security/supply-chain/signatures" \
            -H "Authorization: Bearer ${SUPPLY_CHAIN_API_TOKEN}" \
            -H "Content-Type: application/json" \
            -d "$signature_payload"

  # 密钥泄露检测
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.0/gitleaks_8.18.0_linux_x64.tar.gz
          tar -xzf gitleaks_8.18.0_linux_x64.tar.gz
          chmod +x gitleaks
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks
        run: gitleaks detect --source . --verbose --report-format sarif --report-path gitleaks-results.sarif || true

      - name: Upload gitleaks SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: gitleaks-results.sarif
        if: always()

  # SAST 静态代码分析
  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ['go', 'javascript']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.language }}"

  # 安全报告汇总
  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [go-security, npm-audit, secret-scan, sbom-supply-chain]
    if: always()

    steps:
      - name: Security Scan Summary
        run: |
          echo "# Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Go Security | ${{ needs.go-security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SBOM & Signing | ${{ needs.sbom-supply-chain.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "- Review any failed scans in the job logs" >> $GITHUB_STEP_SUMMARY
          echo "- Update vulnerable dependencies" >> $GITHUB_STEP_SUMMARY
          echo "- Fix any identified security issues" >> $GITHUB_STEP_SUMMARY
